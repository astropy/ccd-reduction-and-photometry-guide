
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>8.1.1. Overview of background subtraction using simulated data &#8212; CCD Data Reduction Guide</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "astropy/ccd-reduction-and-photometry-guide");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-dark");
    script.setAttribute("label", "review-comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("section");
    if (sections !== null && sections.length > 0) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/photometry/01.01.01-Background-removal-simulated-data';</script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.1.2. Handling masking before background removal" href="01.01.02-Background-estimation-XDF.html" />
    <link rel="prev" title="8.1. Background removal for source detection" href="01.01-Background-removal.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../00-00-Preface.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="CCD Data Reduction Guide - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="CCD Data Reduction Guide - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../00-00-Preface.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Data reduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01-00-Understanding-an-astronomical-CCD-image.html">1. Astronomical Images</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../01-01-astronomical-CCD-image-components.html">1.1. Components of astronomical images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-03-Construction-of-an-artificial-but-realistic-image.html">1.2. An artificial, but realistic, image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-04-Nonuniform-sensitivity.html">1.3. Non-uniform sensitivity in astronomical detectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-05-Calibration-overview.html">1.4. Calibration overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-06-Image-combination.html">1.5. Image combination</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-08-Overscan.html">1.6. Overscan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-09-Calibration-choices-you-need-to-make.html">1.7. Calibration choices to make</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-11-reading-images.html">1.8. Reading images</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02-00-Handling-overscan-trimming-and-bias-subtraction.html">2. Overscan and bias images</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../02-01-overscan-trimming-and-bias-subtraction-background.html">2.1. About bias and overscan</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02-02-Calibrating-bias-images.html">2.2. Calibrating bias images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02-04-Combine-bias-images-to-make-master.html">2.3. Combine bias images to make master bias</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../03-00-Dark-current-and-hot-pixels.html">3. Dark current and dark frames</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../03-01-Dark-current-The-ideal-case.html">3.1. Dark current: the ideal case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03-02-Real-dark-current-noise-and-other-artifacts.html">3.2. Real dark current: noise and other artifacts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03-04-Handling-overscan-and-bias-for-dark-frames.html">3.3. Handling overscan and bias for dark frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03-05-Calibrate-dark-images.html">3.4. Calibrate dark images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03-06-Combine-darks-for-use-in-later-calibration-steps.html">3.5. Combine calibrated dark images for use in later reduction steps</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../05-00-Flat-corrections.html">4. Flat fielding</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../05-01-about-flat-corrections.html">4.1. Calibrating flat frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05-03-Calibrating-the-flats.html">4.2. Calibrating flat frames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05-04-Combining-flats.html">4.3. Combining flat frames</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../06-00-Reducing-science-images.html">5. Calibrating science images</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../06-03-science-images-calibration-examples.html">5.1. Two calibration examples</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../08-00-Image-masking.html">6. Finding and dealing with bad pixels</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../08-01-Identifying-hot-pixels.html">6.1. Identifying hot pixels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08-02-Creating-a-mask.html">6.2. Identifying bad pixels with ccdmask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08-03-Cosmic-ray-removal.html">6.3. Removing cosmic rays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08-05-incorporating-masks-into-calibrated-science-images.html">6.4. Incorporating masks in science images</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Photometry</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="00.00-Preface.html">7. Overview</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="01.00-Source-detection.html">8. Source detection</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active has-children"><a class="reference internal" href="01.01-Background-removal.html">8.1. Background estimation</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3 current active"><a class="current reference internal" href="#">8.1.1. Overview with simulated image</a></li>
<li class="toctree-l3"><a class="reference internal" href="01.01.02-Background-estimation-XDF.html">8.1.2. Handling images that need masking</a></li>
<li class="toctree-l3"><a class="reference internal" href="01.01.03-Background-estimation-FEDER.html">8.1.3. Removing a gradient</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/astropy/ccd-reduction-and-photometry-guide/main?urlpath=lab/tree/notebooks/notebooks/photometry/01.01.01-Background-removal-simulated-data.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/edit/main/notebooks/notebooks/photometry/01.01.01-Background-removal-simulated-data.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/astropy/ccd-reduction-and-photometry-guide/issues/new?title=Issue%20on%20page%20%2Fnotebooks/photometry/01.01.01-Background-removal-simulated-data.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/photometry/01.01.01-Background-removal-simulated-data.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Overview of background subtraction using simulated data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-approach-median-or-other-scalar-estimator-of-background">8.1.1.1. Simple approach: median or other scalar estimator of background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pixel-distribution-in-simulated-image">8.1.1.1.1. Pixel distribution in simulated image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-background-value">8.1.1.1.2. Estimating the background value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#best-approach-for-single-value">8.1.1.1.3. Best approach for single value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-caveat-about-the-best-approach">8.1.1.1.4. A caveat about the “best” approach</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#two-dimensional-background">8.1.1.2. Two dimensional background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-some-background-to-the-input-image">8.1.1.2.1. Add some background to the input image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-your-options-for-constructing-the-background">8.1.1.2.2. Choose your options for constructing the background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-the-background">8.1.1.2.3. Display the background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-compare-background-subtracted-data-to-expected-values">8.1.1.2.4. Check: compare background-subtracted data to expected values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-subtracted-image">8.1.1.2.5. Background-subtracted image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">8.1.1.3. Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="overview-of-background-subtraction-using-simulated-data">
<h1><span class="section-number">8.1.1. </span>Overview of background subtraction using simulated data<a class="headerlink" href="#overview-of-background-subtraction-using-simulated-data" title="Link to this heading">#</a></h1>
<p>The first step in detecting sources is to remove any background from the image. There are a number of ways to do this, ranging from subtracting a single value (typically the median or mean) from every pixel to more sophisticated methods either fit a slowly-varying shape to the background or that smooth the input image in some way.</p>
<p>There is probably not a single “best” way to do this; what matters is whether you are able to detect the sources you need to detect in the images you have.</p>
<p>Note that the way you do background removal for source detection does <em>not</em> need to be the same way you do it for photometry. It is perfectly fine to use the same method for both, of course, but it is not required.</p>
<section id="simple-approach-median-or-other-scalar-estimator-of-background">
<h2><span class="section-number">8.1.1.1. </span>Simple approach: median or other scalar estimator of background<a class="headerlink" href="#simple-approach-median-or-other-scalar-estimator-of-background" title="Link to this heading">#</a></h2>
<p>The simplest way to estimate the background is with a single number, perhaps the mean or median of the data. The problem with that approach is that the distribution of pixel value in an astronomical image is not symmetric. Most of the pixels have values near zero while a small number have significantly higher values.</p>
<p>The <a class="reference external" href="https://photutils.readthedocs.io/en/stable/index.html">photutils</a> documentation on <a class="reference external" href="https://photutils.readthedocs.io/en/stable/background.html#scalar-background-and-noise-estimation">scalar background and noise estimation</a> walk through this step-by-step, demonstrating the result you get with a variety of background estimators.</p>
<p>The upshot is that the best estimate of the background is obtained by first masking the sources in the image and then sigma clipping the unmasked parts of the data. The mean and median of the unmasked parts of the image give almost exactly the same value, and standard deviation recovered from the  data matches that of the input.</p>
<section id="pixel-distribution-in-simulated-image">
<h3><span class="section-number">8.1.1.1.1. </span>Pixel distribution in simulated image<a class="headerlink" href="#pixel-distribution-in-simulated-image" title="Link to this heading">#</a></h3>
<p>We begin by constructing a histogram of pixel values in a sample image. The code below illustrates a few useful things from astropy and photutils:</p>
<ul class="simple">
<li><p>photutils comes with useful simulated images.</p></li>
<li><p>astropy comes with a histogram function that will automatically bin the data in a way that brings out features in your data that uniform-width bins might miss.</p></li>
<li><p>astropy has several stretches and normalizations to bring out features in astronomical images.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">Background2D</span><span class="p">,</span> <span class="n">MeanBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span>
<span class="kn">from</span> <span class="nn">photutils.datasets</span> <span class="kn">import</span> <span class="n">make_100gaussians_image</span>
<span class="kn">from</span> <span class="nn">photutils.segmentation</span> <span class="kn">import</span> <span class="n">detect_threshold</span><span class="p">,</span> <span class="n">detect_sources</span>
<span class="kn">from</span> <span class="nn">photutils.utils</span> <span class="kn">import</span> <span class="n">circular_footprint</span>

<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">SqrtStretch</span>
<span class="kn">from</span> <span class="nn">astropy.visualization.mpl_normalize</span> <span class="kn">import</span> <span class="n">ImageNormalize</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">hist</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span><span class="p">,</span> <span class="n">SigmaClip</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">make_100gaussians_image</span><span class="p">()</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f0eb2e57010&gt;
</pre></div>
</div>
<img alt="../../_images/20f808a0b0791a70a216895bb435f3c1a6eef263ee93ff2e6cfb0e826a898278.png" src="../../_images/20f808a0b0791a70a216895bb435f3c1a6eef263ee93ff2e6cfb0e826a898278.png" />
</div>
</div>
<p>There are a couple of things to note about this distrubtion.</p>
<p>The bulk of the pixel values are noise. The function <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.datasets.make_100gaussians_image.html#photutils.datasets.make_100gaussians_image"><code class="docutils literal notranslate"><span class="pre">make_100gaussians_image</span></code></a> adds a background with a Gaussian distribution centered at 5 with a standard deviation of 2. The long tail at higher pixel values are from the sources in the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># IMPORTANT NOTE: flattening the data to one dimension vastly reduces the</span>
<span class="c1"># time it takes to histogram the data.</span>

<span class="n">h</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>
<span class="c1"># The semi-colon supresses a display of the grid object representation</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fd798203e27423eafbbe8a47075f23524784f95dd033aed62e2f12fc1b2ee1c2.png" src="../../_images/fd798203e27423eafbbe8a47075f23524784f95dd033aed62e2f12fc1b2ee1c2.png" />
</div>
</div>
</section>
<section id="estimating-the-background-value">
<h3><span class="section-number">8.1.1.1.2. </span>Estimating the background value<a class="headerlink" href="#estimating-the-background-value" title="Link to this heading">#</a></h3>
<p>The plot below shows the result of several ways of estimating the background from the data. None of these straightforward estimates give a good measure of the true background level, indicated by the green line.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">true_mean</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">avg_all_pixels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">median_all_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">true_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True mean of background&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">avg_all_pixels</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_all_pixels</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median of all values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>

<span class="c1"># Try sigma clipping</span>
<span class="n">clipped_mean</span><span class="p">,</span> <span class="n">clipped_med</span><span class="p">,</span> <span class="n">clipped_std</span>  <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Add line to chart</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">clipped_med</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sigma-clipped median&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of pixels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/aa32f23eed647f24836317060ddb02aa088cd6dc8f04f487983f753fecccac95.png" src="../../_images/aa32f23eed647f24836317060ddb02aa088cd6dc8f04f487983f753fecccac95.png" />
</div>
</div>
<p>None of the estimates above do a particularly good job of estimating the true background level. They also do not do a great job of estimating the error or noise in that background; the input value was 2, but the value produced by sigma clipping is 5% larger:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clipped_std</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.09427521213297
</pre></div>
</div>
</div>
</div>
</section>
<section id="best-approach-for-single-value">
<h3><span class="section-number">8.1.1.1.3. </span>Best approach for single value<a class="headerlink" href="#best-approach-for-single-value" title="Link to this heading">#</a></h3>
<p>The best approach to deriving a single value to use for background is to first mask the sources. There are a few steps to doing that.</p>
<p>First, define the sigma clip parameters for deticting the threshold for sources</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, find pixels more that 2<span class="math notranslate nohighlight">\(\sigma\)</span> above the background using <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.segmentation.detect_threshold.html#photutils.segmentation.detect_threshold"><code class="docutils literal notranslate"><span class="pre">detect_threshold</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">threshold</span> <span class="o">=</span> <span class="n">detect_threshold</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These pixels may be isolated or disconnected. The function <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.segmentation.detect_sources.html#photutils.segmentation.detect_sources"><code class="docutils literal notranslate"><span class="pre">detect_sources</span></code></a>
creates a segmentation image, in which only connected sets of <code class="docutils literal notranslate"><span class="pre">npixels</span></code> or more pixels are identified as sources.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">segment_img</span> <span class="o">=</span> <span class="n">detect_sources</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we use <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.segmentation.SegmentationImage.html#photutils.segmentation.SegmentationImage.make_source_mask"><code class="docutils literal notranslate"><span class="pre">make_source_mask</span></code></a> to create a mask that is <code class="docutils literal notranslate"><span class="pre">True</span></code> where there are sources. It masks out a circular region 10 pixels in size at each source.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">footprint</span> <span class="o">=</span> <span class="n">circular_footprint</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">source_mask</span> <span class="o">=</span> <span class="n">segment_img</span><span class="o">.</span><span class="n">make_source_mask</span><span class="p">(</span><span class="n">footprint</span><span class="o">=</span><span class="n">footprint</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_clip_mean</span><span class="p">,</span> <span class="n">mask_clip_med</span><span class="p">,</span> <span class="n">mask_clip_std</span>  <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">source_mask</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixel values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">true_mean</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True mean of background&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">avg_all_pixels</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean of all values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_all_pixels</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median of all values&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">clipped_med</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sigma-clipped median&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mask_clip_med</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sigma-clipped, sources masked&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;violet&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3716b2b55d05cb5023b46c6369869bd66d31dd87199eaacb2764fa93a92093ba.png" src="../../_images/3716b2b55d05cb5023b46c6369869bd66d31dd87199eaacb2764fa93a92093ba.png" />
</div>
</div>
</section>
<section id="a-caveat-about-the-best-approach">
<h3><span class="section-number">8.1.1.1.4. </span>A caveat about the “best” approach<a class="headerlink" href="#a-caveat-about-the-best-approach" title="Link to this heading">#</a></h3>
<p>Note that the difference in value between the estimates of the background displayed above are not large. The one that is furthest off, the mean of all of the values, differs from the true value by half a count. Whether that is significant or not depends on what science you are trying to do, what sources of error are present in your data and how large they are, and how you will treat the data in later steps.</p>
<p>That is not to say there is anything wrong about the approach described in this section; it is just a reminder that the right choice for your data and science is not necessary what is described here as the best choice.</p>
</section>
</section>
<section id="two-dimensional-background">
<h2><span class="section-number">8.1.1.2. </span>Two dimensional background<a class="headerlink" href="#two-dimensional-background" title="Link to this heading">#</a></h2>
<p>If the background is not uniform (as happens, for example, on a night with moonlight) then using a single value to represent that background will not be effective. Instead, one constructs a background array. It is constructed by breaking the image into pieces, calcuating a scalar background estimate as above, and building those back into a two-dimensional image.</p>
<p>To do this with photutils requires making a few choices:</p>
<ul class="simple">
<li><p><em>What should the mesh size be?</em> This is the size, in pixels, of the chunks into which the image will be split for generating the background. It should be larger than the sources in the image, but small enough to represent variation in background across the image.</p></li>
<li><p><em>How should the background in each mesh cell be calculated?</em> The full suite of options is listed in the <a class="reference external" href="https://photutils.readthedocs.io/en/stable/background.html#d-background-and-noise-estimation">photutils documentation for 2D backgrounds</a>. The example below uses the mean because the sources will be masked as in the scalar case. Other options include the median and <code class="docutils literal notranslate"><span class="pre">SExtractorBackground</span></code> for using the background method used by <a class="reference external" href="https://astromatic.github.io/sextractor/">Source Extractor</a>.</p></li>
<li><p><em>Do you want to also estimate the noise in the background, i.e. the RMS of the background?</em> Again, several options are available.</p></li>
<li><p><em>How do you want the background image interpolated when it is scaled back up to the size of the input image?</em> By default spline interpolation is used, but it can be changed.</p></li>
</ul>
<section id="add-some-background-to-the-input-image">
<h3><span class="section-number">8.1.1.2.1. </span>Add some background to the input image<a class="headerlink" href="#add-some-background-to-the-input-image" title="Link to this heading">#</a></h3>
<p>As with the rest of the examples in this notebook, we closely follow the example from the photutils documentation. The gradient added here might resemble what you would ee on a moonlit night near the moon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[:</span><span class="n">ny</span><span class="p">,</span> <span class="p">:</span><span class="n">nx</span><span class="p">]</span>

<span class="n">gradient</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">50.</span>
<span class="n">gradient_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">gradient</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f0eae8a6a90&gt;
</pre></div>
</div>
<img alt="../../_images/691717e93644692808a62deae37b56ba8406f753565db873bd0f3d93ef48a242.png" src="../../_images/691717e93644692808a62deae37b56ba8406f753565db873bd0f3d93ef48a242.png" />
</div>
</div>
</section>
<section id="choose-your-options-for-constructing-the-background">
<h3><span class="section-number">8.1.1.2.2. </span>Choose your options for constructing the background<a class="headerlink" href="#choose-your-options-for-constructing-the-background" title="Link to this heading">#</a></h3>
<p>For most of the choices in the list above, one creates an instance of the <em>class</em> corresponing to the choice.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose sigma clip parameters</span>

<span class="c1"># Parameters below match those used in sigma_clipped_stats above. The</span>
<span class="c1"># default in photutils is sigma=3, iters=10; this default is used unless</span>
<span class="c1"># you override it as shown below.</span>
<span class="n">sigma_clip</span> <span class="o">=</span> <span class="n">SigmaClip</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Choose your background calculation method</span>
<span class="n">bg_estimator</span> <span class="o">=</span> <span class="n">MeanBackground</span><span class="p">()</span>

<span class="c1"># Choose your mesh size...ideally, an integer number of these fits across</span>
<span class="c1"># the image. Here we use a size such that 10 meshes fit across the image</span>
<span class="c1"># in each directory.</span>
<span class="n">mesh_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Choose an estimator for the noise in the background (i.e. RMS). The</span>
<span class="c1"># default is to use standard deviation using StdBackgroundRMS. This</span>
<span class="c1"># example uses the median absolute deviation for the purposes of</span>
<span class="c1"># illustration.</span>
<span class="n">bg_rms_estimator</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>

<span class="c1"># We could, in principle, specify an interpolator for going from the small</span>
<span class="c1"># mesh to the full size image. By not specifying that we get the default,</span>
<span class="c1"># which is a spline interpolation; photutils calls this BgZoom</span>

<span class="c1"># Finally, construct the background. Each of the choices above are fed into</span>
<span class="c1"># the initialization of the background object.</span>
<span class="n">bgd</span> <span class="o">=</span> <span class="n">Background2D</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">mesh_size</span><span class="p">,</span>
                   <span class="n">sigma_clip</span><span class="o">=</span><span class="n">sigma_clip</span><span class="p">,</span>
                   <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">bg_estimator</span><span class="p">,</span>
                   <span class="n">bkgrms_estimator</span><span class="o">=</span><span class="n">bg_rms_estimator</span><span class="p">,</span>
                  <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="display-the-background">
<h3><span class="section-number">8.1.1.2.3. </span>Display the background<a class="headerlink" href="#display-the-background" title="Link to this heading">#</a></h3>
<p>Though this is not required, we may as well check to see whether the inferred background matches the gradient in the x-direction that we added to the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bgd</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f0eaf869950&gt;
</pre></div>
</div>
<img alt="../../_images/02fc8f890fd313c7f9c6773d3977a31a7fd8d7d4e9d6a7a8243e9dee1e4f607b.png" src="../../_images/02fc8f890fd313c7f9c6773d3977a31a7fd8d7d4e9d6a7a8243e9dee1e4f607b.png" />
</div>
</div>
</section>
<section id="check-compare-background-subtracted-data-to-expected-values">
<h3><span class="section-number">8.1.1.2.4. </span>Check: compare background-subtracted data to expected values<a class="headerlink" href="#check-compare-background-subtracted-data-to-expected-values" title="Link to this heading">#</a></h3>
<p>If the background has been properly substracted, then the median of the subtracted image should be zero (if we mask out the sources) and the rms should be around 2, the value that was used to generate the Gaussian noise in <code class="docutils literal notranslate"><span class="pre">make_100gaussians_image</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">back_sub_data</span> <span class="o">=</span> <span class="n">data2</span> <span class="o">-</span> <span class="n">bgd</span><span class="o">.</span><span class="n">background</span>

<span class="n">sub_mean</span><span class="p">,</span> <span class="n">sub_med</span><span class="p">,</span> <span class="n">sub_std</span>  <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">back_sub_data</span><span class="p">,</span>
                                                  <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sub_mean</span><span class="p">,</span> <span class="n">sub_med</span><span class="p">,</span> <span class="n">sub_std</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.015055447259896278 -0.025952338133033326 2.1121733797664057
</pre></div>
</div>
</div>
</div>
</section>
<section id="background-subtracted-image">
<h3><span class="section-number">8.1.1.2.5. </span>Background-subtracted image<a class="headerlink" href="#background-subtracted-image" title="Link to this heading">#</a></h3>
<p>Finally, we display the background-subtracted image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data2</span> <span class="o">-</span> <span class="n">bgd</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Background subtracted data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Background subtracted data&#39;)
</pre></div>
</div>
<img alt="../../_images/39276fb27d2da687a87c52a9b27b6050ae29d51d4c5e04b0efb3a12944411289.png" src="../../_images/39276fb27d2da687a87c52a9b27b6050ae29d51d4c5e04b0efb3a12944411289.png" />
</div>
</div>
</section>
</section>
<section id="summary">
<h2><span class="section-number">8.1.1.3. </span>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>An image needs to be background-subtracted before you detect the sources in the image. That background can be represented by either a single number (e.g. the mean or median) or by a two-dimensional image. In both cases the best estimate of the background is obtained when sources are masked out before estimating the background. Though this means doing two rounds of source detection, one to estimate the background and one for the actual source detection, the method of finding sources used above is reasonably fast.</p>
<p>Next, we will look at how to do background estimation for a couple of actual science images to get a more nuanced understanding of the choices in background subtraction.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/photometry"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="01.01-Background-removal.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">8.1. </span>Background removal for source detection</p>
      </div>
    </a>
    <a class="right-next"
       href="01.01.02-Background-estimation-XDF.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">8.1.2. </span>Handling masking before background removal</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-approach-median-or-other-scalar-estimator-of-background">8.1.1.1. Simple approach: median or other scalar estimator of background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pixel-distribution-in-simulated-image">8.1.1.1.1. Pixel distribution in simulated image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-the-background-value">8.1.1.1.2. Estimating the background value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#best-approach-for-single-value">8.1.1.1.3. Best approach for single value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-caveat-about-the-best-approach">8.1.1.1.4. A caveat about the “best” approach</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#two-dimensional-background">8.1.1.2. Two dimensional background</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-some-background-to-the-input-image">8.1.1.2.1. Add some background to the input image</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-your-options-for-constructing-the-background">8.1.1.2.2. Choose your options for constructing the background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#display-the-background">8.1.1.2.3. Display the background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-compare-background-subtracted-data-to-expected-values">8.1.1.2.4. Check: compare background-subtracted data to expected values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background-subtracted-image">8.1.1.2.5. Background-subtracted image</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">8.1.1.3. Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Matthew Craig
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2020-2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p xmlns:cc="http://creativecommons.org/ns#" >This work is licensed under
<a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY 4.0
<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1">
<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a></p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>
